<!DOCTYPE html>
<html>
  <head>
  <meta charset="utf-8">
  <!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-GWJGMNS3XR"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-GWJGMNS3XR');
</script>
  
  <title>Azure DevOps Server 入門指南 - 從安裝到 CI/CD 實踐現代化系統開發流程 | The Skeptical Software Engineer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="說明如何使用 Azure DevOps 實踐現代化系統開發流程，從版本控制、持續整合到持續部署。詳細從 Azure DevOps 的安裝、資料庫設定到 Build Machine 的 Agent 安裝、Deploy Target 的 Deployment Group 安裝，到建立完整的 Pipelines，實證從 Visual Studio Commits 到網站終端呈現完整更新結果的全流程 😎">
<meta property="og:type" content="article">
<meta property="og:title" content="Azure DevOps Server 入門指南 - 從安裝到 CI&#x2F;CD 實踐現代化系統開發流程">
<meta property="og:url" content="https://sdwh.dev/posts/2022/03/Azure-DevOps-Server-Tutorial/index.html">
<meta property="og:site_name" content="The Skeptical Software Engineer">
<meta property="og:description" content="說明如何使用 Azure DevOps 實踐現代化系統開發流程，從版本控制、持續整合到持續部署。詳細從 Azure DevOps 的安裝、資料庫設定到 Build Machine 的 Agent 安裝、Deploy Target 的 Deployment Group 安裝，到建立完整的 Pipelines，實證從 Visual Studio Commits 到網站終端呈現完整更新結果的全流程 😎">
<meta property="og:locale">
<meta property="og:image" content="https://sdwh.dev/assets/Azure-DevOps-Logo.png">
<meta property="og:image" content="https://sdwh.dev/assets/Azure-DevOps-Installation-1.png">
<meta property="og:image" content="https://sdwh.dev/assets/Azure-DevOps-Installation-2.png">
<meta property="og:image" content="https://sdwh.dev/assets/Azure-DevOps-Installation-3.png">
<meta property="og:image" content="https://sdwh.dev/assets/Azure-DevOps-Installation-4.png">
<meta property="og:image" content="https://sdwh.dev/assets/Azure-DevOps-Installation-5.png">
<meta property="og:image" content="https://sdwh.dev/assets/Azure-DevOps-Installation-6.png">
<meta property="og:image" content="https://sdwh.dev/assets/Azure-DevOps-Admin-Console.png">
<meta property="og:image" content="https://sdwh.dev/assets/Azure-DevOps-Service-Account.png">
<meta property="og:image" content="https://sdwh.dev/assets/Azure-DevOps-Admin-Console-Backup.png">
<meta property="og:image" content="https://sdwh.dev/assets/Azure-DevOps-Collection-Index.png">
<meta property="og:image" content="https://sdwh.dev/assets/Azure-DevOps-Project-Index.png">
<meta property="og:image" content="https://sdwh.dev/assets/Azure-DevOps-SSH-Setting.png">
<meta property="og:image" content="https://sdwh.dev/assets/Azure-DevOps-Setting-Remote-Repos-SSH-0.png">
<meta property="og:image" content="https://sdwh.dev/assets/Azure-DevOps-Setting-Remote-Repos-SSH-1.png">
<meta property="og:image" content="https://sdwh.dev/assets/Azure-DevOps-New-Agent.png">
<meta property="og:image" content="https://sdwh.dev/assets/Azure-DevOps-Agent-Pools.png">
<meta property="og:image" content="https://sdwh.dev/assets/Azure-DevOps-CI-1.png">
<meta property="og:image" content="https://sdwh.dev/assets/Azure-DevOps-CI-2.png">
<meta property="og:image" content="https://sdwh.dev/assets/Azure-DevOps-CI-3.png">
<meta property="og:image" content="https://sdwh.dev/assets/Azure-DevOps-CI-4.png">
<meta property="og:image" content="https://sdwh.dev/assets/Azure-DevOps-CI-5.png">
<meta property="og:image" content="https://sdwh.dev/assets/Azure-DevOps-CI-6.png">
<meta property="og:image" content="https://sdwh.dev/assets/Azure-DevOps-Deployment-Groups-1-min.png">
<meta property="og:image" content="https://sdwh.dev/assets/Azure-DevOps-Deployment-Groups-2-min.png">
<meta property="og:image" content="https://sdwh.dev/assets/Azure-DevOps-Deployment-Groups-3-min.png">
<meta property="og:image" content="https://sdwh.dev/assets/Azure-DevOps-Release-Pipelines-1.png">
<meta property="og:image" content="https://sdwh.dev/assets/Azure-DevOps-Release-Pipelines-2.png">
<meta property="og:image" content="https://sdwh.dev/assets/Azure-DevOps-Release-Pipelines-3.png">
<meta property="og:image" content="https://sdwh.dev/assets/Azure-DevOps-Release-Pipelines-5.png">
<meta property="og:image" content="https://sdwh.dev/assets/Azure-DevOps-Release-Pipelines-6.png">
<meta property="og:image" content="https://sdwh.dev/assets/Azure-DevOps-Deployment-Groups-5-min.png">
<meta property="og:image" content="https://sdwh.dev/assets/Azure-DevOps-Release-Pipelines-7.png">
<meta property="og:image" content="https://sdwh.dev/assets/Azure-DevOps-Release-Pipelines-8.png">
<meta property="og:image" content="https://sdwh.dev/assets/Azure-DevOps-Release-Pipelines-9.png">
<meta property="og:image" content="https://sdwh.dev/assets/Azure-DevOps-Release-Pipelines-10.png">
<meta property="og:image" content="https://sdwh.dev/assets/Azure-DevOps-Release-Pipelines-11.png">
<meta property="og:image" content="https://sdwh.dev/assets/Azure-DevOps-Auto-CI-CD-2-min.png">
<meta property="og:image" content="https://sdwh.dev/assets/Azure-DevOps-Auto-CI-CD-1-min.png">
<meta property="og:image" content="https://sdwh.dev/assets/Azure-DevOps-Auto-CI-CD-3-min.png">
<meta property="og:image" content="https://sdwh.dev/assets/Azure-DevOps-Auto-CI-CD-5-min.png">
<meta property="og:image" content="https://sdwh.dev/assets/Azure-DevOps-Auto-CI-CD-6-min.png">
<meta property="og:image" content="https://sdwh.dev/assets/Azure-DevOps-Auto-CI-CD-7-min.png">
<meta property="article:published_time" content="2022-03-12T03:42:39.000Z">
<meta property="article:modified_time" content="2024-03-06T10:51:40.305Z">
<meta property="article:author" content="Webber">
<meta property="article:tag" content="Microsoft">
<meta property="article:tag" content="Azure">
<meta property="article:tag" content="DevOps">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://sdwh.dev/assets/Azure-DevOps-Logo.png">
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400&display=swap');
    @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap');
    @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono&display=swap');
  </style>
  
    
      <link rel="icon" href="/assets/favicon.ico">
      
      
        
<link rel="stylesheet" href="/css/style.css">

        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.26.0/themes/prism-okaidia.min.css"/>
<meta name="generator" content="Hexo 6.0.0"><link rel="alternate" href="/atom.xml" title="The Skeptical Software Engineer" type="application/atom+xml">
</head>
      
<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">The Skeptical Software Engineer</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/categories">Categories</a>
        
          <a class="main-nav-link" href="/tags">Tags</a>
        
          <a class="main-nav-link" href="/apps">Apps</a>
        
          <a class="main-nav-link" href="/about">About</a>
        
      </nav>
      <nav id="sub-nav">
        
        <a id="nav-search-btn" class="nav-icon" href="/search/" style="margin-right: 15px;"></a>
      </nav>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-Azure-DevOps-Server-Tutorial" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/posts/2022/03/Azure-DevOps-Server-Tutorial/" class="article-date">
  <time datetime="2022-03-12T03:42:39.000Z" itemprop="datePublished">2022-03-12</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Dev/">Dev</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      Azure DevOps Server 入門指南 - 從安裝到 CI/CD 實踐現代化系統開發流程
    </h1>
  

      </header>
    
    <hr />
    <div class="article-entry" itemprop="articleBody">

      
        
    <div id="toc" class="toc-article">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%92%B0%E5%A2%83%E8%AA%AA%E6%98%8E"><span class="toc-text">環境說明</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Azure-DevOps-Server"><span class="toc-text">Azure DevOps Server</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Database"><span class="toc-text">Database</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Admin-Console"><span class="toc-text">Admin Console</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Azure-DevOps"><span class="toc-text">Azure DevOps</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Version-Control"><span class="toc-text">Version Control</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Continuous-Integration"><span class="toc-text">Continuous Integration</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Build-Machine"><span class="toc-text">Build Machine</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Setting-CI-Pipeline"><span class="toc-text">Setting CI Pipeline</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Continuous-Deployment"><span class="toc-text">Continuous Deployment</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Setting-CD-Pipeline"><span class="toc-text">Setting CD Pipeline</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Auto-CI-amp-CD"><span class="toc-text">Auto CI &amp; CD</span></a></li></ol>
    </div>
  
  
        <hr/>
        <p>說明如何使用 Azure DevOps 實踐現代化系統開發流程，從版本控制、持續整合到持續部署。詳細從 Azure DevOps 的安裝、資料庫設定到 Build Machine 的 Agent 安裝、Deploy Target 的 Deployment Group 安裝，到建立完整的 Pipelines，實證從 Visual Studio Commits 到網站終端呈現完整更新結果的全流程 😎</p>
<a href="/posts/2022/03/Azure-DevOps-Server-Tutorial/" title="logo" class="fancybox" rel="article0">
  <img src="/assets/Azure-DevOps-Logo.png" alt="logo" width="500px">
</a>

<span id="more"></span>

<h2 id="環境說明"><a href="#環境說明" class="headerlink" title="環境說明"></a>環境說明</h2><p>本次要進行的是地端環境 (On-Premises) 的 Azure DevOps Server 安裝，並示範如果整合版本控制、CI &amp; CD，關於 Azure DevOps Server 授權可以參考 <a href="/posts/2022/02/Azure-DevOps-Server/">Azure DevOps Server License &amp; Price 授權與計價方式</a>。</p>
<p>個人是基於研究的興趣才進行本次專案，不是所有的團隊都需要進行地端環境的部署，使用 Azure DevOps 雲端服務，可以讓您的人生輕鬆許多 (Make Your Life Easier) 😉</p>
<p>這篇文章適合有使用過 Visual Studio 以及建立 ASP.NET 進行應用開發，並且有使用 Visual Studio Git 原始碼控制經驗的朋友。如果沒有使用過 Visual Studio &amp; Git 可以參考 <a href="/posts/2020/06/VisualStudio-Git/">Visual Studio 使用 Git 版本控制</a> 的說明。</p>
<p>地端環境部署相關的伺服器資訊：</p>
<table>
<thead>
<tr>
<th>IP</th>
<th>Server</th>
</tr>
</thead>
<tbody><tr>
<td>192.168.112.100</td>
<td>AD Server, DNS Server</td>
</tr>
<tr>
<td>192.168.112.120</td>
<td>Build Machine</td>
</tr>
<tr>
<td>192.168.112.40</td>
<td>DevOps Server</td>
</tr>
<tr>
<td>192.168.112.50</td>
<td>SQL Server</td>
</tr>
<tr>
<td>192.168.112.60</td>
<td>IIS Server</td>
</tr>
</tbody></table>
<h2 id="Azure-DevOps-Server"><a href="#Azure-DevOps-Server" class="headerlink" title="Azure DevOps Server"></a>Azure DevOps Server</h2><p>首先要先到 Active Directory 建立服務帳戶，提供 Azude DevOps 安裝的過程以及連線資料庫所使用。</p>
<p>安裝的過程包含檔案的下載，大約需要 30 分鐘。</p>
<p><img src="/assets/Azure-DevOps-Installation-1.png"></p>
<p>完成安裝後需要進行重新啟動，啟動後就可以看到設置精靈 (Wizard) 出現。</p>
<p><img src="/assets/Azure-DevOps-Installation-2.png"></p>
<p>如果是恢復或者升級 Azure DevOps，可以選擇既有的資料庫，否則選擇建立新的 DevOps Server Deployment。</p>
<p><img src="/assets/Azure-DevOps-Installation-3.png"></p>
<p>安裝上有基本方案與進階方案選擇，進階方案提供了與 SQL Server Reporting Services 的整合，本次選擇基本方案。</p>
<p><img src="/assets/Azure-DevOps-Installation-4.png"></p>
<p>在搜尋選項，可以設定是否要啟動 Collection 層級的搜尋功能，可以用於搜尋 Work Item 以及 Wiki 內容，非常方便，但本次示範為簡化不特別進行設定。</p>
<p><img src="/assets/Azure-DevOps-Installation-5.png"></p>
<p>完成設定後進行 Configure 設定，等待完成 (大約 15分鐘左右)</p>
<p><img src="/assets/Azure-DevOps-Installation-6.png"></p>
<h3 id="Database"><a href="#Database" class="headerlink" title="Database"></a>Database</h3><p>Database <strong>除了 SQL Server Dtabase Engine 外，還需要全文檢索引擎的功能</strong>，此外如果搭配進階的 DevOps 方案，還需要安裝 Reporting Services。</p>
<p>將服務帳戶加入 SQL Server Login</p>
<p>在 DevOps 安裝的過程，會建立 <strong>AzureDevOps_Configuration</strong> 資料庫，用於保存 DevOps 的組態設定。</p>
<p>此外會建立 <strong>AzureDevOps_DefaultCollection</strong> 資料庫，所有 Default Collection 下的專案都會保存在這個資料庫，而如果建立新的 Collection 會再另外建立新的 Database。因此可以得知 DevOps 是以 Database 來區隔不同的 Collection。</p>
<h3 id="Admin-Console"><a href="#Admin-Console" class="headerlink" title="Admin Console"></a>Admin Console</h3><p>藉由登入 DevOps Server 使用 Admin Console 可以進行相關的組態調整，包含建立新的 Collection 等設定。</p>
<p><img src="/assets/Azure-DevOps-Admin-Console.png"></p>
<p>可以在 Admin Console 調整 DevOps 使用的 Service Account</p>
<p><img src="/assets/Azure-DevOps-Service-Account.png"></p>
<p>DevOps 的資料集中在所使用的資料庫當中，而 Admin Console 提供了備份介面，在正式環境不要忘記定期對資料進行備份。</p>
<p><img src="/assets/Azure-DevOps-Admin-Console-Backup.png"></p>
<h3 id="Azure-DevOps"><a href="#Azure-DevOps" class="headerlink" title="Azure DevOps"></a>Azure DevOps</h3><p>完成設定後，從 DevOps Binding 的網址，就可以進入 DevOps 的頁面囉</p>
<p><img src="/assets/Azure-DevOps-Collection-Index.png" alt="Collection Page"></p>
<p><img src="/assets/Azure-DevOps-Project-Index.png" alt="Project Page"></p>
<h2 id="Version-Control"><a href="#Version-Control" class="headerlink" title="Version Control"></a>Version Control</h2><p>因為沒有使用 AD Certificate Service，所以沒有辦法自簽憑證使用 HTTPS 的方式發行專案。因此改以 SSH 的方式進行，首先要推送專案的 Client 端必須要先使用 <code class="s">ssh-keygen</code> 產生 id_rsa 以及 id_rsa.pub，產生的結果會儲存在 user 路徑下的 <code class="s">.ssh</code>。</p>
<p>建立的過程會需要指定一組 Password Pharase，之後發次 Commit 專案透過 SSH 都會使用到這組 Pharase。</p>
<pre class="line-numbers language-batch" data-language="batch"><code class="language-batch"><span class="token command"><span class="token keyword">cd</span> c:\users\developer</span>
<span class="token command"><span class="token keyword">ssh</span>-keygen <span class="token parameter attr-name">-t</span> rsa <span class="token parameter attr-name">-C</span> <span class="token string">"developer@sdwh.dev"</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>接著將 id_ras.pub 的內容複製後，到 Azure DevOps 使用者的 SSH 設定加入：</p>
<p><img src="/assets/Azure-DevOps-SSH-Setting.png"></p>
<p>接著在 Visual Studio 專案進行 Git 設定，將遠端位址改為 ssh 路徑，路徑可以由 DevOps 的 Repo 中取得。</p>
<p><img src="/assets/Azure-DevOps-Setting-Remote-Repos-SSH-0.png" alt="DevOps SSH"></p>
<p><img src="/assets/Azure-DevOps-Setting-Remote-Repos-SSH-1.png" alt="Visual Studio Remote"></p>
<p>完成後就可以將專案由 Visual Studio 推送到 Azure DevOps Repos 囉 🙂</p>
<h2 id="Continuous-Integration"><a href="#Continuous-Integration" class="headerlink" title="Continuous Integration"></a>Continuous Integration</h2><h3 id="Build-Machine"><a href="#Build-Machine" class="headerlink" title="Build Machine"></a>Build Machine</h3><p>如果 Build Machine 使用的 Windows 10 / 11 因為評估版的授權期限較短，可以使用 <code class="s">rearm</code> 重新取得 90 天授權，最多可以使用 2 次，微軟真是佛心來著 😲</p>
<pre class="line-numbers language-batch" data-language="batch"><code class="language-batch"><span class="token command"><span class="token keyword">slmgr</span> -rearm</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>使用「專案設定 (Project Settings)」在 Pipelines 下選擇「代理程式集區 (Agent Pools)」並由「代理程式 (Agents)」下新增新的代理程式。</p>
<p><img src="/assets/Azure-DevOps-New-Agent.png" alt="New Agent"></p>
<p>為了要註冊 Agent，首先從 DevOps 提示的連結將 vsts-agent-win-x64-2.181.2.zip 進行下載到 Build Machine，接著使用 PowerShell 執行安裝的 Script，稍待一會就可以完成 Agent 註冊：</p>
<pre class="line-numbers language-powershell" data-language="powershell"><code class="language-powershell"><span class="token function">Add-Type</span> <span class="token operator">-</span>AssemblyName System<span class="token punctuation">.</span>IO<span class="token punctuation">.</span>Compression<span class="token punctuation">.</span>FileSystem <span class="token punctuation">;</span> 
<span class="token namespace">[System.IO.Compression.ZipFile]</span>::ExtractToDirectory<span class="token punctuation">(</span>
    <span class="token string">"C:\Downloads\vsts-agent-win-x64-2.181.2.zip"</span><span class="token punctuation">,</span> <span class="token string">"<span class="token variable">$PWD</span>"</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>安裝的過程會詢問是否要註冊為 Windows Service，但不斷 Y、Y、Y 都無法成功，最後只能在完成後用 <code class="s">run.bat</code> 的方式啟動 Agent，很不方便 🤨</p>
<div class="colorbox space">
    <div class="shadow">
        <div class="tab-info tab-icon-success"><i></i></div>
        <div class="colorbox-body colorbox-body-success">
            <p>後來發現雖然提示是 Y/N 但實際上要輸入的是 true 才是表示輸入 Y 😅</p>
        </div>
    </div>
</div>

<p>完成 agent 註冊為服務後，可以使用 <code class="s">services.msc</code> 去檢查服務的自動啟動是否有延遲，記得要調整為不要有延遲 😉</p>
<p>而完成 Agent 註冊後，可以到 DevOps 上的<strong>代理</strong>進行確認：</p>
<p><img src="/assets/Azure-DevOps-Agent-Pools.png" alt="Agent Pools"></p>
<p>原本 Build Machine 有安裝 Visual Studio 2022 Community 但在執行 CI 的時候，DevOps 一直報錯說找不到 MSBuild 相關工具，不確定是 VS 2022 尚未支援或者是 Community Edition 的問題？後來改在 Build Machine 上安裝 <a target="_blank" rel="noopener" href="https://visualstudio.microsoft.com/zh-hant/vs/older-downloads/">Visual Studio 2019 Build Tools</a> 後重新啟動就可以了 😁</p>
<h3 id="Setting-CI-Pipeline"><a href="#Setting-CI-Pipeline" class="headerlink" title="Setting CI Pipeline"></a>Setting CI Pipeline</h3><p>開始建立 CI Pipeline</p>
<p><img src="/assets/Azure-DevOps-CI-1.png"></p>
<p>目前主流的開發方式都是使用 YAML 來設計 Pipeline 以達到 Infra As Code，但筆者目前對於使用 YAML 來設計 Pipeline 完全沒有相關經驗，因此這次的示範是以「傳統編輯器」的方式來設計 Pipeline。</p>
<p><img src="/assets/Azure-DevOps-CI-2.png"></p>
<p>資料來源因為是使用版控在 Azure DevOps 上的 Repos 所以就是 <strong>Azure Repos Git</strong></p>
<p><img src="/assets/Azure-DevOps-CI-3.png"></p>
<p>本次使用的是 「ASP.NET Web 應用程式」使用 .NET Framework 4.7.2 設計 ASP.NET MVC 5 的專案，因此選擇 <strong>ASP.NET</strong> 範本。</p>
<p><img src="/assets/Azure-DevOps-CI-4.png"></p>
<p>這邊需要選擇集區 (Agent Pools) 所以要先完成集區以及代理程式 (Agent) 的建立。</p>
<p><img src="/assets/Azure-DevOps-CI-5.png"></p>
<p>手動執行 Build 後，可以看到編譯過程以及是否有錯誤及警告。</p>
<p><img src="/assets/Azure-DevOps-CI-6.png" alt="CI Success"></p>
<h2 id="Continuous-Deployment"><a href="#Continuous-Deployment" class="headerlink" title="Continuous Deployment"></a>Continuous Deployment</h2><p>從專案選擇「部署群組 (Deployment groups)」用以建立部署目標伺服器，例如 IIS Server。</p>
<p><img src="/assets/Azure-DevOps-Deployment-Groups-1-min.png"></p>
<p>只要將 DevOps 上提供的 PowerShell Script 複製到 Target Server 上執行即可 (執行須使用 Administrator 身分並且只有用 PowerShell 不能用 PowerShell ISE)。過程中會需要確認以什麼樣的服務權限來讓 DevOps 進行部署使用，預設是 <code class="s">NT Authority\SYSTEM</code>。</p>
<div class="colorbox space">
    <div class="shadow">
        <div class="tab-info tab-icon-danger"><i></i></div>
        <div class="colorbox-body colorbox-body-danger">
            <p>需要注意的是 PowerShell Script 裡面，預設提供的 "Administrator" 使用的雙引號是 <code class="s">U+201C “</code> 以及 <code class="s">U+201D ”</code>，不是每個作業系統，尤其是中文語系的都吃這一套 🤣 如果執行 PowerShell Script 發生錯誤，記得將雙引號取代為常見的 <code class="s">U+0022 "。</code></p>
        </div>
    </div>
</div>

<p><img src="/assets/Azure-DevOps-Deployment-Groups-2-min.png"></p>
<p>在註冊部署群組的時候，會出現驗證方式，需要輸入 PAT，給予<strong>部署群組 讀取與管理權限即可</strong>。</p>
<p>另除了 PAT 外，也可以使用 Negotiate ，輸入 AD 驗證的方式進行註冊。</p>
<p>而如果註冊時發生 <strong>TF400813</strong> 錯誤時，重新輸入的 URL 必須包含 Collection 名稱，例如：</p>
<pre class="line-numbers language-plain" data-language="plain"><code class="language-plain">https://devops.sdwh.local/DefaultCollection<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>如果目標伺服器已經註冊為部署集區 (Deployment Pools) 的成員，則可以將目標伺服器所在的集區反向建立為專案的部署群組 (Deployment Groups)，這樣一來就不需要每個專案都重複對相同的 IIS Server 註冊為 Deployment Pool。</p>
<p><img src="/assets/Azure-DevOps-Deployment-Groups-3-min.png"></p>
<p>完成後可以在 DevOps 上進行確認</p>
<h3 id="Setting-CD-Pipeline"><a href="#Setting-CD-Pipeline" class="headerlink" title="Setting CD Pipeline"></a>Setting CD Pipeline</h3><p>開始建立 CD Pipeline：</p>
<p><img src="/assets/Azure-DevOps-Release-Pipelines-1.png"></p>
<p>範本選擇「IIS 網站部署」，其他幾個選項都很相似，所以在部署上需要有相當的 IIS、Azure 管理經驗，才能夠將原本的部署作業方式轉換為 Infra As Code 的部署管線方式。</p>
<p><img src="/assets/Azure-DevOps-Release-Pipelines-2.png"></p>
<p>首先要指定<strong>成品</strong>，成品就是從 CI 階段 Build 無誤的成果，在 CD 階段用以部署到 IIS 伺服器上。</p>
<p><img src="/assets/Azure-DevOps-Release-Pipelines-3.png"></p>
<p>在階段的組態類型，要注意需要建立的是 IIS 站台、Application 或者是虛擬目錄，這個地方很容易因為選錯卡關，具體的差異需要有使用 IIS 的經驗。</p>
<p><img src="/assets/Azure-DevOps-Release-Pipelines-5.png"></p>
<p>本次示範選擇的是 <code class="s">IIS Web Application</code>，要注意的是虛擬目錄必須是 <code class="s">/</code> 開頭。</p>
<p><img src="/assets/Azure-DevOps-Release-Pipelines-6.png"></p>
<p>首先設定 IIS Web App Manage 的相關設定，這邊可以設定是否建立新的集區以及要發佈到 IIS Server 的那個實體路徑：</p>
<p><img src="/assets/Azure-DevOps-Deployment-Groups-5-min.png"></p>
<p>接著設定 IIS Web App Deploy，這邊可以設定部署是否先將程式離線、刪除已存在檔案等設定對應於以往使用 Visual Studio 發佈到 IIS Server 上的相關設定：</p>
<div class="colorbox space">
    <div class="shadow">
        <div class="tab-info tab-icon-danger"><i></i></div>
        <div class="colorbox-body colorbox-body-danger">
            <p>需要注意的是在 Web App Deploy 一定要設定虛擬應用程式的位址，而且必須與 Web App Manage 的虛擬路徑相同，否則會造成 DevOps Deploy 的檔案無法建立成功，但 CD 管線卻正常完成的 Bug (耗費 2 個小時 Debug 的心淚) 😥</p>
        </div>
    </div>
</div>

<p><img src="/assets/Azure-DevOps-Release-Pipelines-7.png"></p>
<p>建立好<strong>發行管線</strong>後，還需要建立發行 (Release) 才能夠進行部署。</p>
<p><img src="/assets/Azure-DevOps-Release-Pipelines-8.png"></p>
<p>首先設定發行的成品來源：</p>
<p><img src="/assets/Azure-DevOps-Release-Pipelines-9.png"></p>
<p>點選建立好的發行，並手動按下<strong>部署</strong>：</p>
<p><img src="/assets/Azure-DevOps-Release-Pipelines-10.png"></p>
<p>讓子彈飛一會兒，很順利的部署完成了，我們可以到 IIS Server 去驗證。</p>
<p>而雖然這次的部署順利的完成了，但過程中可是幾經波折，包括成品的位置不正確、組態類型沒有選擇 Application 等等，反覆測試了很多次，卡關將近一個小時才解決。</p>
<p>這也說明了在做 CD 時，一開始為了將原本部署作業，改為由 Continuous Deployment 會碰到的轉換困難。而如果團隊不僅一種部署方式，這邊會需要下的功夫只會更多，因為需要針對每種部署方式都有對應的設定方式。</p>
<p><img src="/assets/Azure-DevOps-Release-Pipelines-11.png"></p>
<h2 id="Auto-CI-amp-CD"><a href="#Auto-CI-amp-CD" class="headerlink" title="Auto CI &amp; CD"></a>Auto CI &amp; CD</h2><p>完成手動 CI &amp; CD 只完成了一半，接下來要讓整個 CI &amp; CD 過程能夠自動化。</p>
<p>首先到 CI Pipeline 進行設定，啟用<strong>持續整合</strong>的設定</p>
<p><img src="/assets/Azure-DevOps-Auto-CI-CD-2-min.png"></p>
<p>接著到 CD Pipeline 進行設定，將部署的階段調整為<strong>持續部署觸發程序</strong></p>
<p><img src="/assets/Azure-DevOps-Auto-CI-CD-1-min.png"></p>
<p>接著馬上來驗證 CI &amp; CD 是否已經自動化，使用 Visual Studio 進行程式碼設計，並將結果 Commit 到 DevOps Server：</p>
<p><img src="/assets/Azure-DevOps-Auto-CI-CD-3-min.png"></p>
<p>從 CI Pipeline 的資訊，我們可以發現 CI 作業隨著收到最新的 Commit 已經開始自動工作了</p>
<p><img src="/assets/Azure-DevOps-Auto-CI-CD-5-min.png"></p>
<p>CI 完成後，CD 也開始接續工作，將 CI 產生的成品進行部署到伺服器上</p>
<p><img src="/assets/Azure-DevOps-Auto-CI-CD-6-min.png"></p>
<p>順利的完成之後，我們使用瀏覽器瀏覽 IIS Server 的網站，發現更新已經成功了，我們整個自動化 CI &amp; CD 設定完成了！</p>
<p><img src="/assets/Azure-DevOps-Auto-CI-CD-7-min.png"></p>

      

    </div>
    <footer class="article-footer">
      <a data-url="https://sdwh.dev/posts/2022/03/Azure-DevOps-Server-Tutorial/" data-id="clzv7ms8x00dgxots2w9xehfm" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Azure/" rel="tag">Azure</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/DevOps/" rel="tag">DevOps</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Microsoft/" rel="tag">Microsoft</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/posts/2022/03/SQL-Server-Performance-Tuning/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">SQL Server Performance Tuning 效能調校 🚀</div>
    </a>
    
    
  
    <a href="/posts/2022/03/Azure-Certification-AZ-204-Lab/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          Azure Learn AZ-204 The Hard Way | 實作 AZ-204 Lab 01 App Services
        
      </div>
    </a>
  

  
</nav>

  
</article>

</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title widget-category-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/AI/">AI</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Blog/">Blog</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Cloud/">Cloud</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/CyberSecurity/">CyberSecurity</a><span class="category-list-count">33</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Database/">Database</a><span class="category-list-count">155</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Design/">Design</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Dev/">Dev</a><span class="category-list-count">287</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Docker/">Docker</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/EngDiary/">EngDiary</a><span class="category-list-count">46</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/IIS/">IIS</a><span class="category-list-count">42</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/LearningNote/">LearningNote</a><span class="category-list-count">24</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/LifeHack/">LifeHack</a><span class="category-list-count">18</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Linux/">Linux</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Microsoft/">Microsoft</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Misc/">Misc</a><span class="category-list-count">52</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Mobile/">Mobile</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Network/">Network</a><span class="category-list-count">11</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/News/">News</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/OS/">OS</a><span class="category-list-count">75</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Office/">Office</a><span class="category-list-count">13</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/PowerBI/">PowerBI</a><span class="category-list-count">10</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Resource/">Resource</a><span class="category-list-count">11</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Toys/">Toys</a><span class="category-list-count">23</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/TroubleShooting/">TroubleShooting</a><span class="category-list-count">5</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Vue/">Vue</a><span class="category-list-count">13</span></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title widget-archive-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/">2024</a><span class="archive-list-count">107</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/">2023</a><span class="archive-list-count">140</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/">2022</a><span class="archive-list-count">218</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/">2021</a><span class="archive-list-count">241</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/">2020</a><span class="archive-list-count">128</span></li></ul>
    </div>
  </div>


  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      <!-- 2024 -->
      The Skeptical Software Engineer &copy; 2020 - <span class="margin-right"></span>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/categories" class="mobile-nav-link">Categories</a>
  
    <a href="/tags" class="mobile-nav-link">Tags</a>
  
    <a href="/apps" class="mobile-nav-link">Apps</a>
  
    <a href="/about" class="mobile-nav-link">About</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<!-- <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/10.0.3/highlight.min.js"></script> -->


  
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.26.0/prism.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.26.0/plugins/autoloader/prism-autoloader.min.js"></script>

<script src="/js/script.js"></script>


<script src="/js/custom-script.js"></script>





<!-- <script>hljs.initHighlightingOnLoad();</script> -->
  </div>
</body>
</html>