<!DOCTYPE html>
<html>
  <head>
  <meta charset="utf-8">
  <!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-GWJGMNS3XR"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-GWJGMNS3XR');
</script>
  
  <title>SQL Server Nuts å …æœçš„å …æŒ Day3 (Disk &amp; Storage) | The Skeptical Software Engineer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="SQL Server å …æœçš„å …æŒå­¸ç¿’ç­†è¨˜ç³»åˆ—ï¼Œä¸ä¸­æ–·çš„é€£çºŒå­¸ç¿’ï¼Œæ·±å…¥ SQL Server æ ¸å¿ƒçŸ¥è­˜ ğŸ¥œ">
<meta property="og:type" content="article">
<meta property="og:title" content="SQL Server Nuts å …æœçš„å …æŒ Day3 (Disk &amp; Storage)">
<meta property="og:url" content="https://sdwh.dev/posts/2022/10/SQL-Server-Nuts-Disk-And-Storage/index.html">
<meta property="og:site_name" content="The Skeptical Software Engineer">
<meta property="og:description" content="SQL Server å …æœçš„å …æŒå­¸ç¿’ç­†è¨˜ç³»åˆ—ï¼Œä¸ä¸­æ–·çš„é€£çºŒå­¸ç¿’ï¼Œæ·±å…¥ SQL Server æ ¸å¿ƒçŸ¥è­˜ ğŸ¥œ">
<meta property="og:locale">
<meta property="og:image" content="https://sdwh.dev/assets/SQL-Server-Nuts-Learning-Series.jpg">
<meta property="article:published_time" content="2022-10-05T11:13:56.000Z">
<meta property="article:modified_time" content="2023-04-01T12:13:24.956Z">
<meta property="article:author" content="Webber">
<meta property="article:tag" content="Database">
<meta property="article:tag" content="SQLServer">
<meta property="article:tag" content="Series">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://sdwh.dev/assets/SQL-Server-Nuts-Learning-Series.jpg">
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400&display=swap');
    @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap');
    @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono&display=swap');
  </style>
  
    
      <link rel="icon" href="/assets/favicon.ico">
      
      
        
<link rel="stylesheet" href="/css/style.css">

        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.26.0/themes/prism-okaidia.min.css"/>
<meta name="generator" content="Hexo 6.0.0"><link rel="alternate" href="/atom.xml" title="The Skeptical Software Engineer" type="application/atom+xml">
</head>
      
<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">The Skeptical Software Engineer</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/categories">Categories</a>
        
          <a class="main-nav-link" href="/tags">Tags</a>
        
          <a class="main-nav-link" href="/apps">Apps</a>
        
          <a class="main-nav-link" href="/about">About</a>
        
      </nav>
      <nav id="sub-nav">
        
        <a id="nav-search-btn" class="nav-icon" href="/search/" style="margin-right: 15px;"></a>
      </nav>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-SQL-Server-Nuts-Disk-And-Storage" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/posts/2022/10/SQL-Server-Nuts-Disk-And-Storage/" class="article-date">
  <time datetime="2022-10-05T11:13:56.000Z" itemprop="datePublished">2022-10-05</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Database/">Database</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      SQL Server Nuts å …æœçš„å …æŒ Day3 (Disk &amp; Storage)
    </h1>
  

      </header>
    
    <hr />
    <div class="article-entry" itemprop="articleBody">

      
        
    <div id="toc" class="toc-article">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%AA%AA%E6%98%8E"><span class="toc-text">èªªæ˜</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Buffer-Pool"><span class="toc-text">Buffer Pool</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Latches"><span class="toc-text">Latches</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Logical-Read-amp-Physical-Read"><span class="toc-text">Logical Read &amp; Physical Read</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Data-Reads"><span class="toc-text">Data Reads</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Data-Writes"><span class="toc-text">Data Writes</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#sys-dm-io-virtual-file-stats-view"><span class="toc-text">sys.dm_io_virtual_file_stats view</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Performance-Counter"><span class="toc-text">Performance Counter</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#I-O-Wait-Types"><span class="toc-text">I&#x2F;O Wait Types</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Best-Practice-Checklist"><span class="toc-text">Best Practice Checklist</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%B4%B0%E8%AA%AA%E5%84%AA%E5%8C%96%E8%A8%AD%E5%AE%9A"><span class="toc-text">ç´°èªªå„ªåŒ–è¨­å®š</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#CheckPoints-Tuning"><span class="toc-text">CheckPoints Tuning</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%83%E8%80%83%E8%B3%87%E6%96%99"><span class="toc-text">åƒè€ƒè³‡æ–™</span></a></li></ol>
    </div>
  
  
        <hr/>
        <p>SQL Server å …æœçš„å …æŒå­¸ç¿’ç­†è¨˜ç³»åˆ—ï¼Œä¸ä¸­æ–·çš„é€£çºŒå­¸ç¿’ï¼Œæ·±å…¥ SQL Server æ ¸å¿ƒçŸ¥è­˜ ğŸ¥œ</p>
<a href="/posts/2022/10/SQL-Server-Nuts-Disk-And-Storage/" title="SQL Server Logo" class="fancybox" rel="article0">
  <img src="/assets/SQL-Server-Nuts-Learning-Series.jpg" alt="SQL Server Nuts Logo" width="600px" style="border-radius: 10px;">
</a>

<span id="more"></span>

<h2 id="èªªæ˜"><a href="#èªªæ˜" class="headerlink" title="èªªæ˜"></a>èªªæ˜</h2><h3 id="Buffer-Pool"><a href="#Buffer-Pool" class="headerlink" title="Buffer Pool"></a>Buffer Pool</h3><p>SQL Server ä¸æœƒç›´æ¥å¾ Data files å–å¾—è³‡æ–™é  (data pages)ï¼Œè€Œæ˜¯æœƒä»¥è¨˜æ†¶é«”å»ºæ§‹çš„ buffer pool å°‡æ‰€éœ€çš„è³‡æ–™é å¿«å–æ–¼ buffer poolã€‚</p>
<p>Buffer çš„çµæ§‹åŒ…å« Data Page çš„ä½å€ (Address)ã€è¨˜æ†¶é«”ä¸­è³‡æ–™é çš„æŒ‡æ¨™ (Pointer)ã€Page latching queue ä»¥åŠç‹€æ…‹è³‡è¨Š (status information)ã€‚</p>
<h3 id="Latches"><a href="#Latches" class="headerlink" title="Latches"></a>Latches</h3><p>Latches æ˜¯ SQL Server å…§éƒ¨ç”¨æ–¼è™•ç†è¨˜æ†¶é«”ä¸­çš„ç‰©ä»¶ï¼Œé¿å…åœ¨å¤šå€‹ Threads (Work) å°ç‰©ä»¶çš„ç•°å‹• (Modification) è€Œå—åˆ°æ±™æŸ“ (Corruption)ã€‚</p>
<p>æœ€å¸¸è¦‹çš„ Latch åŒ…å« <strong>Exclusive</strong>ï¼Œæ’é™¤å…¶ä»–çš„è®€å–èˆ‡ç•°å‹•ï¼›<strong>Shared</strong>ï¼Œå…è¨±åŒæ™‚çš„è®€å–ä½†ç¦æ­¢ç•°å‹•ã€‚latches èˆ‡ç¨‹å¼èªè¨€çš„ <strong>critical sections</strong> æˆ– <strong>mutexes</strong> æ¦‚å¿µç›¸ä¼¼ã€‚</p>
<h3 id="Logical-Read-amp-Physical-Read"><a href="#Logical-Read-amp-Physical-Read" class="headerlink" title="Logical Read &amp; Physical Read"></a>Logical Read &amp; Physical Read</h3><p>ç•¶ SQL Server éœ€è¦å­˜å– Data Page æ™‚ï¼Œå¾ Buffer pool å–å› Data Page çš„å‹•ä½œç¨±ç‚º <strong>logical read</strong>ï¼Œè€Œä¸å†è¨˜æ†¶é«”ç•¶ä¸­é ˆå¾è¼‰å…¥ Buffer pool çš„å‹•ä½œå‰‡ç¨±ç‚º <strong>Physical read</strong>ã€‚</p>
<p>ç•¶è³‡æ–™éœ€è¦ç•°å‹•æ™‚ï¼ŒSQL Server é¦–å…ˆæœƒå°‡ log å¯«å…¥äº¤æ˜“ç´€éŒ„ï¼Œæ¥è‘—ç•°å‹• Buffer pool ç•¶ä¸­çš„ Data Pageï¼Œä½¿è³‡æ–™è®Šå¾— Dirty (è¢«ç•°å‹•)ã€‚è€Œç•¶ç™¼ç”Ÿ CheckPoint æˆ– Lazy Writer çš„æ™‚å€™ï¼Œæ‰æœƒå¾ Buffer pool å°‡ Data Page å¯«å…¥è³‡æ–™æª”ã€‚</p>
<p>é è¨­ä¸Šæ‰€æœ‰çš„ Schedulers éƒ½æœƒåƒèˆ‡ I/O çš„å·¥ä½œï¼Œè€Œä¸€ä»¶ I/O éœ€æ±‚ï¼Œå¯èƒ½ç”±ä¸åŒçš„ Worker æ‰€åƒèˆ‡å®Œæˆã€‚</p>
<p><span class="keywords">sys.dm_io_pending_io_requests</span> å¯ä»¥è§€å¯Ÿ</p>
<h3 id="Data-Reads"><a href="#Data-Reads" class="headerlink" title="Data Reads"></a>Data Reads</h3><p>ç•¶ SQL Server éœ€è¦ Data Page æ™‚ï¼Œé¦–å…ˆæª¢æŸ¥ Buffer pool æ˜¯å¦å­˜åœ¨éœ€è¦çš„ Data Pageï¼Œå¦å‰‡ Worker æœƒåˆ†é… Buffer çµ¦éœ€è¦çš„è³‡æ–™é ï¼Œä¸¦ä¸”ä»¥ Exclusive Latch ä¿è­·ã€‚</p>
<p>æ¥è‘—æœƒç™¼å‹• I/O éœ€æ±‚ï¼Œä¸¦å°‡éœ€æ±‚åŠ å…¥åˆ° Scheduler çš„ I/O ä½‡åˆ— (Queue)ï¼ŒåŒæ™‚ç™¼èµ· OS API å·²é€²è¡Œè®€å–ã€‚åŒæ™‚åœ¨ Buffer ä¸ŠåŠ å…¥ Shared Latchï¼Œè€Œå› ç‚ºè©² Buffer æ­£å— Excludsive Latchï¼Œæ­¤æ™‚ Worker æœƒé€²å…¥ Suspend ç‹€æ…‹ï¼Œè™•æ–¼ PAGEIOLATCH ç­‰å¾…ã€‚</p>
<p>ç•¶å¦ä¸€å€‹ Worker é€²å…¥ RUNNING ç‹€æ…‹æ™‚ï¼Œå®ƒæœƒæª¢æŸ¥ Scheduler çš„ I/O Queue æ˜¯å¦ä»æœ‰é …ç›®ï¼Œå¦‚æœæ²’æœ‰æœƒè—‰ç”± callback function ä¾†çµæŸæ“ä½œï¼Œcallback function æœƒæª¢æŸ¥ padge æ²’æœ‰è¢«å…¶ä»–æ“ä½œæ±™æŸ“ (corrupted)ï¼Œæ¥è‘—å¾ Buffer ä¸­ç§»é™¤ exclusive latchã€‚æœ€å¾Œ Worker æœƒé€å‡º I/O éœ€æ±‚ï¼Œå¯ä»¥æ¢å¾©åŠå­˜å– Data Pageã€‚</p>
<h3 id="Data-Writes"><a href="#Data-Writes" class="headerlink" title="Data Writes"></a>Data Writes</h3><p>ç•¶è³‡æ–™åº«ç™¼ç”Ÿè³‡æ–™ç•°å‹•ï¼ŒSQL Server æœƒå…ˆç•°å‹• Buffer Pool ä¸­çš„è³‡æ–™é ï¼Œä¸¦ç”¢ç”Ÿ Log å„²å­˜åœ¨äº¤æ˜“ç´€éŒ„ç•¶ä¸­ï¼Œè€Œç›´åˆ°äº¤æ˜“ç´€éŒ„è¢«å®Œæ•´è¨˜éŒ„ï¼Œè³‡æ–™ç•°å‹•çš„äº¤æ˜“æ‰ç®—æ˜¯å®Œæˆã€‚</p>
<p>ç•¶ç™¼ç”Ÿ CheckPoint ä»¥åŠ lazy writer çš„æ™‚å€™ï¼ŒSQL Server æ‰æœƒå°‡ Buffer pool çš„è³‡æ–™å¯«å› Data Filesã€‚</p>
<p><strong>CheckPoint</strong> æ˜¯ç‚ºäº†æ¸›å°‘è³‡æ–™åº«å¾©åŸæ™‚é–“ï¼Œå°‡è¨˜æ†¶é«”çš„è³‡æ–™å¯«å…¥ mdfï¼›<strong>Lazy Writer</strong> æ˜¯ç‚ºæ¸›å°‘è¨˜æ†¶é«”å£“åŠ›ï¼Œå°‡è¨˜æ†¶é«”çš„è³‡æ–™å¯«å…¥ mdfã€‚é è¨­ä¸Š CheckPoint ä¸æœƒæ¸…é™¤è¨˜æ†¶é«”ä¸­çš„è³‡æ–™ï¼Œå¿…é ˆè¦æ‰‹å‹•æ¸…é™¤ï¼š</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">CHECKPOINT</span>
GO
<span class="token keyword">DBCC</span> DROPCLEANBUFFERS
GO<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="sys-dm-io-virtual-file-stats-view"><a href="#sys-dm-io-virtual-file-stats-view" class="headerlink" title="sys.dm_io_virtual_file_stats view"></a>sys.dm_io_virtual_file_stats view</h3><p>å¾ DMV <code class="s">sys.dm_io_virtual_file_stats view</code> è§€å¯Ÿ stalls (è³‡æ–™é è®€å–çš„æ™‚é–“)</p>
<p>ç›®æ¨™æ˜¯è¶Šå°çš„ stalls æ™‚é–“è¶Šä½³ï¼Œæ ¹æ“šç¶“é©—æ³•å‰‡äº¤æ˜“ç´€éŒ„çš„å¯«å…¥æ‡‰å°æ–¼ 2 msã€è³‡æ–™æª”çš„è®€å–å‰‡æ‡‰å°æ–¼ 5msã€‚</p>
<p>ç•¶æŸ¥è©¢æ‰€éœ€çš„è³‡æ–™å‚³è¼¸é‡è¶Šå¤š (throughput)ï¼Œè³‡æ–™è®€å–çš„æ™‚é–“ä¹Ÿæœƒæˆé•· (stalls)ï¼Œè€Œå¦‚æœåœ¨é«˜ stalls å»æ˜¯ä½ throughput çš„æƒ…æ³ï¼Œæ•ˆèƒ½çš„å•é¡Œå¯èƒ½ä¸æ˜¯åœ¨ SQL Server ä¸Šã€‚è€Œå¾ˆé«˜çš„ staslls ä¹Ÿæœƒåæ˜ åœ¨ <strong>PAGGEIOLATCH</strong> ç­‰å¾…é¡å‹ä»¥åŠè³‡æ–™é çš„çŸ­ç”Ÿå‘½é€±æœŸã€‚</p>
<p>å¢åŠ è³‡æ–™åº«ä¼ºæœå™¨çš„è¨˜æ†¶é«”ï¼Œå› ç‚ºå¯ä»¥å¿«å–æ›´å¤šçš„è³‡æ–™é ï¼Œä¹Ÿå¢åŠ è³‡æ–™é åœ¨è¨˜æ†¶é«”ä¸­çš„ç”Ÿå‘½é€±æœŸï¼Œèƒ½å¤ ç·©è§£ stalss å¢åŠ çš„å•é¡Œã€‚</p>
<p><strong>ä¸‹åˆ—çš„è³‡æ–™åº«èª¿æ ¡éƒ½æœ‰åŠ©æ–¼é™ä½ stallsï¼š</strong></p>
<ul>
<li>ç§»é™¤ä¸å¿…è¦çš„ç´¢å¼•</li>
<li>è—‰ç”±èª¿æ•´ FILLFACTOR æ¸›å°‘ page splits</li>
<li>ç´¢å¼•ç¶­è­·ç­–ç•¥çš„èª¿æ•´</li>
<li>Data compression æ¸›å°‘è³‡æ–™é æ•¸é‡</li>
<li>èª¿æ•´è³‡æ–™åº«çš„ Schema</li>
</ul>
<h3 id="Performance-Counter"><a href="#Performance-Counter" class="headerlink" title="Performance Counter"></a>Performance Counter</h3><p>ä½¿ç”¨ Windows çš„ <code class="s">perfmon</code> è§€å¯Ÿä¸‹åˆ—ç£ç¢Ÿç›¸é—œæŒ‡æ¨™é€²è¡Œæ•ˆèƒ½èª¿æ ¡èˆ‡æ•ˆèƒ½è­°é¡Œé™¤éŒ¯ã€‚</p>
<p><code class="watch">Physical disk</code></p>
<p>Avg Disk Queue Length<br>Avg Disk sec/Read<br>Avg Disk sec/Write</p>
<p><code class="watch">SQL Server: Buffer Manager</code></p>
<p>Checkpoint pages/sec<br>Background writer pages/sec<br>Lazy writer/sec<br>Page reads/sec<br>Page writes/sec<br>Readahead pages/sec<br>SQL Server: Databases<br>Log Bytes Flushed/sec<br>Log Flush Write Time (ms)<br>Log Flushes/sec</p>
<p><code class="watch">SQL Server: SQL Statistics</code></p>
<p>Batch Requests/sec<br>SQL Server: Databases<br>Transactions/sec</p>
<h3 id="I-O-Wait-Types"><a href="#I-O-Wait-Types" class="headerlink" title="I/O Wait Types"></a>I/O Wait Types</h3><p><code class="watch">ASYNC_IO_COMPLETION</code></p>
<p>ç­‰å¾…é¡å‹ç™¼ç”Ÿæ–¼ SQL Server ç­‰å¾…å¾ Data files çš„éåŒæ­¥çš„ I/O è®€å–æˆ–å¯«å…¥ã€‚</p>
<p><strong>Regular checkpoint</strong><br>é€²è¡Œè³‡æ–™åº«å‚™ä»½æˆ– <code class="s">DBCC CHECKDB</code> çš„ Internal checkpointã€‚</p>
<p><strong>Reading GAM pages from data files</strong><br>åŸºæ–¼è³‡æ–™åº«å‚™ä»½æ‰€ç™¼ç”Ÿçš„è®€å– Data Pagesã€‚</p>
<p><code class="watch">IO_COMPLETION</code></p>
<p>ç­‰å¾…é¡å‹ç™¼ç”Ÿæ–¼åŒæ­¥è®€å–æˆ–å¯«å…¥è³‡æ–™æª”ï¼Œæˆ–è€…å¾äº¤æ˜“ç´€éŒ„é€²è¡Œè®€å–ï¼Œä¾‹å¦‚ï¼š</p>
<ul>
<li>Reading allocation map pages from the database</li>
<li>Reading the transaction log during database recovery</li>
<li>Writing data to tempdb during sort spills</li>
</ul>
<p><code class="watch">WRITELOG</code></p>
<p>ç­‰å¾…é¡å‹ç™¼ç”Ÿæ–¼è³‡æ–™åº«å¯«å…¥äº¤æ˜“ç´€éŒ„ï¼Œéé«˜çš„æ¯”ç‡è¡¨ç¤ºäº¤æ˜“ç´€éŒ„çš„å¯«å…¥ç™¼ç”Ÿç“¶é ¸ã€‚</p>
<p><code class="watch">WRITE_COMPLETION</code></p>
<p>ç­‰å¾…é¡å‹ç™¼ç”Ÿæ–¼åŒæ­¥å¯«å…¥è³‡æ–™åº«èˆ‡äº¤æ˜“ç´€éŒ„ï¼Œå¸¸è¦‹æ–¼ Database Snapshotsï¼Œè€Œåœ¨ <code class="s">DBCC CHECKDB</code> çš„æ™‚å€™ä¹Ÿæœƒç”¢ç”Ÿ internal database snapshotsã€‚</p>
<p><code class="watch">PAGEIOLATCH</code></p>
<p>ç­‰å¾…é¡å‹ç™¼ç”Ÿæ–¼ SQL Server å¾ Data Files è®€å– Data Pagesï¼Œå¤§é‡çš„ PAGEIOLATCH é¡¯ç¤ºè³‡æ–™åº«ç¶“å¸¸è™•æ–¼å¾ Data Files è®€å– Data Pagesï¼Œé€šå¸¸æºè‡ªæ–¼ï¼š</p>
<ul>
<li>SQL Server ç¡¬é«”è³‡æºä¸è¶³ï¼Œè¨˜æ†¶é«”ç„¡æ³•å¿«å–è¶³å¤ çš„ Data Pages</li>
<li>æœªæœ€ä½³åŒ–çš„æŸ¥è©¢ï¼Œé€ æˆ Buffer pool åœ¨è¨˜æ†¶é«”ä¸­ä¸æ–·ç½®æ› Data Pages (å› ç‚ºè¨˜æ†¶é«”æœ‰é™)</li>
</ul>
<p>å¢åŠ è¨˜æ†¶é«”æ˜¯æœ€å®¹æ˜“è§£æ±º PAGEIOLATCH çš„æ–¹å¼ï¼Œä½†å„ªåŒ–æŸ¥è©¢ (Optimizing) è£ç¤ºè§£æ±ºçš„æ ¹æœ¬ä¹‹é“ã€‚</p>
<p><strong>PAGEIOLATCH_EX</strong><br>ç™¼ç”Ÿæ–¼ Worker æƒ³è¦æ›´æ–° Data Pages ä¸¦ä¸”åœ¨ç­‰å¾…è©² Page å¾ Data files è¢«è¼‰å…¥ Buffer poolã€‚</p>
<p><strong>PAGEIOLATCH_SH</strong><br>ç™¼ç”Ÿæ–¼ Worker æƒ³è¦è®€å– Data Pageï¼Œä¸¦ä¸”åœ¨ç­‰å¾…è©² Page å¾ Data files è¢«è¼‰å…¥ Buffer poolã€‚</p>
<p><strong>PAGEIOLATCH_UP</strong><br>ç™¼ç”Ÿæ–¼ Worke æƒ³è¦æ›´æ–° System Page (ä¾‹å¦‚ allocation map)ï¼Œä¸¦ä¸”åœ¨ç­‰å¾… Page å¾ Data files è¢«è¼‰å…¥ Buffer poolã€‚</p>
<h2 id="Best-Practice-Checklist"><a href="#Best-Practice-Checklist" class="headerlink" title="Best Practice Checklist"></a>Best Practice Checklist</h2><p>è—‰ç”± <strong>sys.dm_io_virtual_file_stats</strong> æª¢æŸ¥å„²å­˜çš„å»¶é² (Latency &amp; Stalls)</p>
<p>è—‰ç”±åˆ†æ Performance Counters ä»¥æª¢æŸ¥é«˜å»¶é²æ˜¯å¦æºè‡ªæ–¼ç¬é–“çˆ†ç™¼ (Bursts) çš„ I/O æ´»å‹• (ä¾‹å¦‚ Checkpoint)</p>
<p>å¦‚æœæ˜¯ Checkpoint é€ æˆ I/O å•é¡Œï¼Œå¯ä»¥è—‰ç”±èª¿æ•´ç‚º indirect checkpoints çš„æ–¹å¼æ§åˆ¶ã€‚</p>
<p>è—‰ç”±è§€å¯Ÿ <strong>WRITELOG</strong> çš„ç­‰å¾…é¡å‹ï¼Œç¢ºèªäº¤æ˜“ç´€éŒ„æ˜¯å¦æœ‰æ•ˆèƒ½ä¸Šçš„å•é¡Œã€‚</p>
<p>è—‰ç”±è§€å¯Ÿ <strong>IO_COMPLETION</strong> çš„ç­‰å¾…é¡å‹ï¼Œç¢ºèª tempdb æ˜¯å¦å­˜åœ¨æ•ˆèƒ½å•é¡Œã€‚</p>
<p>è—‰ç”±è§€å¯Ÿ <strong>PAGEIOLATCH</strong> åˆ¤æ–·æ˜¯å¦æœ‰æœªæœ€ä½³åŒ–çš„æŸ¥è©¢ã€‚</p>
<h2 id="ç´°èªªå„ªåŒ–è¨­å®š"><a href="#ç´°èªªå„ªåŒ–è¨­å®š" class="headerlink" title="ç´°èªªå„ªåŒ–è¨­å®š"></a>ç´°èªªå„ªåŒ–è¨­å®š</h2><h3 id="CheckPoints-Tuning"><a href="#CheckPoints-Tuning" class="headerlink" title="CheckPoints Tuning"></a>CheckPoints Tuning</h3><blockquote>
<p>åœ¨è¨±å¤šæƒ…æ³ä¸‹ï¼ŒI/O çš„å»¶é²æ˜¯ä¾†è‡ªæ–¼ç¬é–“çˆ†ç™¼çš„ I/O éœ€æ±‚ï¼Œè€Œ Checkpoint Process çš„ç™¼ç”Ÿï¼Œæ˜¯æœ€å¸¸è¦‹çš„è‚‡å› ã€‚</p>
</blockquote>
<p>Checkpoint æ˜¯ç‚ºäº†å°‡ Data Pages å„²å­˜è‡³ Data filesï¼Œç›®çš„æ˜¯ç‚ºæ¸›å°‘è³‡æ–™åº«çš„é‚„åŸæ™‚é–“ (failover / carsh)ï¼Œå› ç‚ºå¯ä»¥æ¸›å°‘é‚„åŸæ™‚æ‰€éœ€é‡æ–°é€²è¡Œäº¤æ˜“ç´€éŒ„ (replay) çš„æ™‚é–“ã€‚</p>
<p>å¯ä»¥è—‰ç”±èª¿æ•´ <strong>recovery target</strong> ä¾†å¢åŠ  Checkpont çš„ç™¼ç”Ÿé »ç‡ï¼Œå¾è€Œæ¸›å°‘ç¬é–“çˆ†ç™¼çš„å•é¡Œã€‚</p>
<p><code class="watch">Checkpoint çš„ç™¼ç”Ÿé¡å‹èˆ‡æ™‚æ©Ÿ</code></p>
<dl>
  <dt>Internal</dt>
  <dd>å‚™ä»½æˆ–å»ºç«‹è³‡æ–™åº« snapshot æ™‚</dd>
  <dt>Manual</dt>
  <dd>æ‰‹å‹•åŸ·è¡Œ <code class="s">CHECKPOINT</code></dd>
  <dt>Automatic</dt>
  <dd>ç”± SQL Server å…§éƒ¨æ©Ÿåˆ¶åˆ¤æ–·å®šæœŸé€²è¡Œï¼Œå¯èƒ½æœƒå°è‡´ç©ç´¯çš„ Dirty Page ä¸€æ¬¡å¯«å…¥é€ æˆ I/O å•é¡Œ</dd>
  <dt>Indirect</dt>
  <dd>è—‰ç”±è¨­å®šè³‡æ–™åº«çš„ <code class="s">TARGET_RECOVERY_TIME</code> å¢åŠ  Checkpoint é »ç‡</dd>
</dl>

<h2 id="åƒè€ƒè³‡æ–™"><a href="#åƒè€ƒè³‡æ–™" class="headerlink" title="åƒè€ƒè³‡æ–™"></a>åƒè€ƒè³‡æ–™</h2><p><a target="_blank" rel="noopener" href="https://www.tenlong.com.tw/products/9781098101923">SQL Server Advanced Troubleshooting and Performance Tuning: Best Practices and Techniques</a></p>
<p><a target="_blank" rel="noopener" href="https://www.tenlong.com.tw/products/9781803242620">SQL Server Query Tuning and Optimization: Optimize Microsoft SQL Server 2022 queries and applications</a></p>
<p><a target="_blank" rel="noopener" href="https://www.brentozar.com/blog/">Brent OZAR</a></p>

      

    </div>
    <footer class="article-footer">
      <a data-url="https://sdwh.dev/posts/2022/10/SQL-Server-Nuts-Disk-And-Storage/" data-id="cluwog6m801kuv0ts1f9lgroi" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Database/" rel="tag">Database</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/SQLServer/" rel="tag">SQLServer</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Series/" rel="tag">Series</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/posts/2022/10/Document-For-Newbie/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">è®“æ–‡ä»¶ç‡Ÿé€ å‹å–„çš„å…±åŒä½œæ¥­ç’°å¢ƒ (Documents for newbies)</div>
    </a>
    
    
  
    <a href="/posts/2022/10/Connect-To-DB2-With-Open-Solutions/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          Windows é–‹æ”¾ç’°å¢ƒå¦‚ä½•é€£ç·šè‡³ IBM DB2 Database Server
        
      </div>
    </a>
  

  
</nav>

  
</article>

</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title widget-category-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Blog/">Blog</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Cloud/">Cloud</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/CyberSecurity/">CyberSecurity</a><span class="category-list-count">32</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Database/">Database</a><span class="category-list-count">148</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Design/">Design</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Dev/">Dev</a><span class="category-list-count">260</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Docker/">Docker</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/EngDiary/">EngDiary</a><span class="category-list-count">22</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/IIS/">IIS</a><span class="category-list-count">42</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/LearningNote/">LearningNote</a><span class="category-list-count">24</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/LifeHack/">LifeHack</a><span class="category-list-count">17</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Linux/">Linux</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Microsoft/">Microsoft</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Misc/">Misc</a><span class="category-list-count">50</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Mobile/">Mobile</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Network/">Network</a><span class="category-list-count">11</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/News/">News</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/OS/">OS</a><span class="category-list-count">74</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Office/">Office</a><span class="category-list-count">13</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/PowerBI/">PowerBI</a><span class="category-list-count">10</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Resource/">Resource</a><span class="category-list-count">11</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Toys/">Toys</a><span class="category-list-count">23</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/TroubleShooting/">TroubleShooting</a><span class="category-list-count">5</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Vue/">Vue</a><span class="category-list-count">13</span></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title widget-archive-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/">2024</a><span class="archive-list-count">43</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/">2023</a><span class="archive-list-count">140</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/">2022</a><span class="archive-list-count">218</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/">2021</a><span class="archive-list-count">241</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/">2020</a><span class="archive-list-count">128</span></li></ul>
    </div>
  </div>


  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      <!-- 2024 -->
      The Skeptical Software Engineer &copy; 2020 - <span class="margin-right"></span>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/categories" class="mobile-nav-link">Categories</a>
  
    <a href="/tags" class="mobile-nav-link">Tags</a>
  
    <a href="/apps" class="mobile-nav-link">Apps</a>
  
    <a href="/about" class="mobile-nav-link">About</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<!-- <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/10.0.3/highlight.min.js"></script> -->


  
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.26.0/prism.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.26.0/plugins/autoloader/prism-autoloader.min.js"></script>

<script src="/js/script.js"></script>


<script src="/js/custom-script.js"></script>





<!-- <script>hljs.initHighlightingOnLoad();</script> -->
  </div>
</body>
</html>